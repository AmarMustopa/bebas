{% extends 'monitoring/base.html' %}
{% load static %}

{% block content %}
<div class="status-card">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-semibold">Sensor Configuration</h1>
        <button onclick="showAddSensorModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            <i class="fas fa-plus mr-2"></i>Add New Sensor
        </button>
    </div>

    {% if messages %}
    <div class="mb-4">
        {% for message in messages %}
        <div class="p-4 {% if message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-red-100 text-red-700{% endif %} rounded-lg">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="overflow-x-auto relative" id="sensorTable">
        <!-- Loading state -->
        <div class="loading-overlay absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center" style="display: none;">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>Warning Threshold</th>
                    <th>Danger Threshold</th>
                    <th>Device ID</th>
                    <th>Update Interval</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if not sensors %}
                <tr>
                    <td colspan="7" class="text-center py-8 text-gray-500">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-sensor-off text-4xl mb-2"></i>
                            <p>No sensors configured yet</p>
                            <button onclick="showAddSensorModal()" class="text-blue-600 hover:text-blue-800 mt-2">
                                <i class="fas fa-plus mr-1"></i>Add your first sensor
                            </button>
                        </div>
                    </td>
                </tr>
                {% endif %}
                
                {% for sensor in sensors %}
                <tr>
                    <td>{{ sensor.name }}</td>
                    <td>{{ sensor.sensor_type }}</td>
                    <td>{{ sensor.threshold_warning|default:"-" }}</td>
                    <td>{{ sensor.threshold_danger|default:"-" }}</td>
                    <td>{{ sensor.device_id|default:"-" }}</td>
                    <td>{{ sensor.update_interval }}s</td>
                    <td>
                        <button onclick="editSensor({{ sensor.id }})" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSensor({{ sensor.id }})" class="text-red-600 hover:text-red-800 ml-3">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-4 text-gray-500">
                        No sensor configurations yet. Click "Add New Sensor" to create one.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Sensor Modal -->
<div id="sensorModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeSensorModal()">&times;</span>
        <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add New Sensor</h2>
        <form method="post" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="id" id="sensor_id">
            <div>
                <label class="block text-sm font-medium text-gray-700">Name</label>
                <input type="text" name="name" id="sensor_name" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Type</label>
                <select name="sensor_type" id="sensor_type" required
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    {% for type in sensor_types %}
                    <option value="{{ type }}">{{ type }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Warning Threshold</label>
                <input type="number" step="0.01" name="threshold_warning" id="threshold_warning"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Danger Threshold</label>
                <input type="number" step="0.01" name="threshold_danger" id="threshold_danger"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Device ID</label>
                <input type="text" name="device_id" id="device_id"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Update Interval (seconds)</label>
                <input type="number" name="update_interval" id="update_interval" required min="1"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeSensorModal()"
                    class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
                <button type="submit"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h2 class="text-2xl font-bold mb-4">Confirm Delete</h2>
        <p class="mb-4">Are you sure you want to delete this sensor configuration?</p>
        <div class="flex justify-end space-x-3">
            <button onclick="closeDeleteModal()"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300">Cancel</button>
            <form method="post" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete">
                <input type="hidden" name="sensor_id" id="delete_sensor_id">
                <button type="submit"
                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Delete</button>
            </form>
        </div>
    </div>
</div>

<script>
function showAddSensorModal() {
    document.getElementById('modalTitle').textContent = 'Add New Sensor';
    document.getElementById('sensor_id').value = '';
    document.getElementById('sensor_name').value = '';
    document.getElementById('sensor_type').value = 'MQ2';
    document.getElementById('threshold_warning').value = '';
    document.getElementById('threshold_danger').value = '';
    document.getElementById('device_id').value = '';
    document.getElementById('update_interval').value = '10';
    document.getElementById('sensorModal').style.display = 'block';
}

function editSensor(id) {
    // Fetch sensor data and populate form
    fetch(`/api/sensor/${id}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('modalTitle').textContent = 'Edit Sensor';
            document.getElementById('sensor_id').value = data.id;
            document.getElementById('sensor_name').value = data.name;
            document.getElementById('sensor_type').value = data.sensor_type;
            document.getElementById('threshold_warning').value = data.threshold_warning || '';
            document.getElementById('threshold_danger').value = data.threshold_danger || '';
            document.getElementById('device_id').value = data.device_id || '';
            document.getElementById('update_interval').value = data.update_interval;
            document.getElementById('sensorModal').style.display = 'block';
        });
}

function closeSensorModal() {
    document.getElementById('sensorModal').style.display = 'none';
}

function deleteSensor(id) {
    document.getElementById('delete_sensor_id').value = id;
    document.getElementById('deleteModal').style.display = 'block';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.className === 'modal') {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}